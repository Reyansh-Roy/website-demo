<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARC & LRDI Focus Engine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- THEME: Lo-fi Study Room --- */
        :root {
            --bg-color: #161625;
            --primary-accent: #7f5af0; /* A vibrant purple */
            --secondary-accent: #2cb67d; /* A calming, bright green/cyan */
            --text-color: #dcdcdc;
            --heading-color: #fffffe;
            --subtle-glow: rgba(255, 198, 92, 0.4); /* Warm lamp glow */
            --glass-bg: rgba(22, 22, 37, 0.7);
            --glass-border: rgba(127, 90, 240, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow-y: scroll; }

        /* --- Animated Lo-fi Background --- */
        .background-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; background-image: url('https://i.pinimg.com/originals/82/30/a4/8230a472c6383a8ef1372a9177821689.gif'); background-size: cover; background-position: center center; filter: brightness(0.8); }

        /* --- Main Content Container --- */
        .container { max-width: 1000px; margin: 40px auto; padding: 20px; }

        /* --- Motivating Greeting --- */
        #greeting { font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 2.8rem; text-align: center; margin-bottom: 2rem; color: var(--heading-color); text-shadow: 0 0 10px var(--subtle-glow), 0 0 20px var(--subtle-glow); min-height: 50px; }
        #greeting::after { content: '|'; animation: blink 1s step-end infinite; color: var(--secondary-accent); }
        @keyframes blink { from, to { opacity: 0; } 50% { opacity: 1; } }

        /* --- Form Styling --- */
        .section-title { font-size: 2rem; text-align: center; letter-spacing: 1px; color: var(--heading-color); padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); }
        .hint { text-align: center; font-style: italic; font-weight: 400; color: #a9a9a9; margin: 5px 0 40px 0; }
        
        /* --- Frosted Glass UI Blocks --- */
        .passage-block { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 30px; margin-bottom: 40px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); transition: border-color 0.3s; }
        .passage-block h3 { font-size: 1.5rem; font-weight: 700; margin-bottom: 15px; color: var(--primary-accent); }
        label { display: block; margin-bottom: 8px; font-weight: 700; color: #c0c0c0; }
        label.answer-label { margin-top: 20px; font-weight: 500; color: var(--secondary-accent); }

        /* --- Textarea with a "Code Editor" Feel --- */
        textarea { width: 100%; min-height: 180px; font-family: 'JetBrains Mono', monospace; font-size: 1rem; background: rgba(10, 10, 20, 0.8); border: 1px solid rgba(127, 90, 240, 0.4); border-radius: 8px; padding: 15px; color: var(--text-color); resize: vertical; transition: border-color 0.3s, box-shadow 0.3s; }
        textarea.passage-input { min-height: 300px; }
        textarea:focus { outline: none; border-color: var(--secondary-accent); box-shadow: 0 0 10px rgba(44, 182, 125, 0.3); }

        .questions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px; }

        /* --- LRDI Image Upload Styling --- */
        .image-upload-area { margin-top: 25px; }
        .image-drop-zone { border: 2px dashed var(--glass-border); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: background-color 0.3s, border-color 0.3s; }
        .image-drop-zone:hover, .image-drop-zone.dragover { background-color: var(--glass-bg); border-color: var(--primary-accent); }
        .image-drop-zone p { font-size: 1rem; color: #a9a9a9; pointer-events: none; }
        .file-input { display: none; }
        .image-preview { display: none; max-width: 100%; margin-top: 15px; border-radius: 8px; border: 1px solid var(--glass-border); }
        
        .paste-btn {
            background-color: var(--secondary-accent);
            color: var(--heading-color);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        .paste-btn:hover {
             background-color: #35d491;
        }

        /* --- Vibrant Submission Button --- */
        .submit-btn { display: block; width: 100%; padding: 18px; font-family: 'Nunito', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--heading-color); background: var(--primary-accent); border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s; margin-top: 20px; }
        .submit-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(127, 90, 240, 0.3); background: #9a7bff; }
        
        /* --- Status Message --- */
        #status-message { text-align: center; margin-top: 20px; font-size: 1rem; min-height: 24px; }
    </style>
</head>
<body>

    <div class="background-container"></div>

    <div class="container">
        <h1 id="greeting"></h1>

        <form id="main-form">
            <h2 class="section-title">Reading Comprehension Section</h2>
            <p class="hint">(Passages & Questions 1-16)</p>
            <div class="passage-block"><h3>Passage 1 & Directions</h3><textarea id="passage1" name="passage1" class="passage-input" placeholder="..."></textarea><div class="questions-grid"><div class="qa-pair"><label for="q1">Question 1</label><textarea id="q1" name="q1"></textarea><label for="a1" class="answer-label">Answer for Q1</label><textarea id="a1" name="a1"></textarea></div><div class="qa-pair"><label for="q2">Question 2</label><textarea id="q2" name="q2"></textarea><label for="a2" class="answer-label">Answer for Q2</label><textarea id="a2" name="a2"></textarea></div><div class="qa-pair"><label for="q3">Question 3</label><textarea id="q3" name="q3"></textarea><label for="a3" class="answer-label">Answer for Q3</label><textarea id="a3" name="a3"></textarea></div><div class="qa-pair"><label for="q4">Question 4</label><textarea id="q4" name="q4"></textarea><label for="a4" class="answer-label">Answer for Q4</label><textarea id="a4" name="a4"></textarea></div></div></div>
            <div class="passage-block"><h3>Passage 2</h3><textarea id="passage2" name="passage2" class="passage-input" placeholder="..."></textarea><div class="questions-grid"><div class="qa-pair"><label for="q5">Question 5</label><textarea id="q5" name="q5"></textarea><label for="a5" class="answer-label">Answer for Q5</label><textarea id="a5" name="a5"></textarea></div><div class="qa-pair"><label for="q6">Question 6</label><textarea id="q6" name="q6"></textarea><label for="a6" class="answer-label">Answer for Q6</label><textarea id="a6" name="a6"></textarea></div><div class="qa-pair"><label for="q7">Question 7</label><textarea id="q7" name="q7"></textarea><label for="a7" class="answer-label">Answer for Q7</label><textarea id="a7" name="a7"></textarea></div><div class="qa-pair"><label for="q8">Question 8</label><textarea id="q8" name="q8"></textarea><label for="a8" class="answer-label">Answer for Q8</label><textarea id="a8" name="a8"></textarea></div></div></div>
            <div class="passage-block"><h3>Passage 3</h3><textarea id="passage3" name="passage3" class="passage-input" placeholder="..."></textarea><div class="questions-grid"><div class="qa-pair"><label for="q9">Question 9</label><textarea id="q9" name="q9"></textarea><label for="a9" class="answer-label">Answer for Q9</label><textarea id="a9" name="a9"></textarea></div><div class="qa-pair"><label for="q10">Question 10</label><textarea id="q10" name="q10"></textarea><label for="a10" class="answer-label">Answer for Q10</label><textarea id="a10" name="a10"></textarea></div><div class="qa-pair"><label for="q11">Question 11</label><textarea id="q11" name="q11"></textarea><label for="a11" class="answer-label">Answer for Q11</label><textarea id="a11" name="a11"></textarea></div><div class="qa-pair"><label for="q12">Question 12</label><textarea id="q12" name="q12"></textarea><label for="a12" class="answer-label">Answer for Q12</label><textarea id="a12" name="a12"></textarea></div></div></div>
            <div class="passage-block"><h3>Passage 4</h3><textarea id="passage4" name="passage4" class="passage-input" placeholder="..."></textarea><div class="questions-grid"><div class="qa-pair"><label for="q13">Question 13</label><textarea id="q13" name="q13"></textarea><label for="a13" class="answer-label">Answer for Q13</label><textarea id="a13" name="a13"></textarea></div><div class="qa-pair"><label for="q14">Question 14</label><textarea id="q14" name="q14"></textarea><label for="a14" class="answer-label">Answer for Q14</label><textarea id="a14" name="a14"></textarea></div><div class="qa-pair"><label for="q15">Question 15</label><textarea id="q15" name="q15"></textarea><label for="a15" class="answer-label">Answer for Q15</label><textarea id="a15" name="a15"></textarea></div><div class="qa-pair"><label for="q16">Question 16</label><textarea id="q16" name="q16"></textarea><label for="a16" class="answer-label">Answer for Q16</label><textarea id="a16" name="a16"></textarea></div></div></div>
            
            <h2 class="section-title">Verbal Ability Section</h2>
            <p class="hint">(Questions 17-24)</p>
            <div class="passage-block"><h3>Verbal Ability Questions</h3><div class="questions-grid"><div class="qa-pair"><label for="q17">Question 17</label><textarea id="q17" name="q17"></textarea><label for="a17" class="answer-label">Answer for Q17</label><textarea id="a17" name="a17"></textarea></div><div class="qa-pair"><label for="q18">Question 18</label><textarea id="q18" name="q18"></textarea><label for="a18" class="answer-label">Answer for Q18</label><textarea id="a18" name="a18"></textarea></div><div class="qa-pair"><label for="q19">Question 19</label><textarea id="q19" name="q19"></textarea><label for="a19" class="answer-label">Answer for Q19</label><textarea id="a19" name="a19"></textarea></div><div class="qa-pair"><label for="q20">Question 20</label><textarea id="q20" name="q20"></textarea><label for="a20" class="answer-label">Answer for Q20</label><textarea id="a20" name="a20"></textarea></div><div class="qa-pair"><label for="q21">Question 21</label><textarea id="q21" name="q21"></textarea><label for="a21" class="answer-label">Answer for Q21</label><textarea id="a21" name="a21"></textarea></div><div class="qa-pair"><label for="q22">Question 22</label><textarea id="q22" name="q22"></textarea><label for="a22" class="answer-label">Answer for Q22</label><textarea id="a22" name="a22"></textarea></div><div class="qa-pair"><label for="q23">Question 23</label><textarea id="q23" name="q23"></textarea><label for="a23" class="answer-label">Answer for Q23</label><textarea id="a23" name="a23"></textarea></div><div class="qa-pair"><label for="q24">Question 24</label><textarea id="q24" name="q24"></textarea><label for="a24" class="answer-label">Answer for Q24</label><textarea id="a24" name="a24"></textarea></div></div></div>

            <h2 class="section-title">LRDI Section</h2>
            <p class="hint">(Sets & Questions 1-20)</p>

            <div class="passage-block">
                <h3>LRDI Set 1 (Questions 1-5)</h3>
                <textarea id="lrdi_para1" name="lrdi_para1" class="passage-input" placeholder="Paste the text for LRDI Set 1 here..."></textarea>
                <div class="image-upload-area" id="image-area-1">
                    <label>Image for Set 1 (Optional)</label>
                    <div class="image-drop-zone">
                        <p>Drag & Drop, Paste, or Click to Select</p>
                    </div>
                    <button type="button" class="paste-btn">Paste from Clipboard</button>
                    <input type="file" class="file-input" accept="image/png, image/jpeg">
                    <img class="image-preview" alt="Image preview for Set 1">
                </div>
                <div class="questions-grid">
                    <div class="qa-pair"><label for="lrdi_q1">Question 1</label><textarea id="lrdi_q1" name="lrdi_q1"></textarea><label for="lrdi_a1" class="answer-label">Answer for Q1</label><textarea id="lrdi_a1" name="lrdi_a1"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q2">Question 2</label><textarea id="lrdi_q2" name="lrdi_q2"></textarea><label for="lrdi_a2" class="answer-label">Answer for Q2</label><textarea id="lrdi_a2" name="lrdi_a2"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q3">Question 3</label><textarea id="lrdi_q3" name="lrdi_q3"></textarea><label for="lrdi_a3" class="answer-label">Answer for Q3</label><textarea id="lrdi_a3" name="lrdi_a3"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q4">Question 4</label><textarea id="lrdi_q4" name="lrdi_q4"></textarea><label for="lrdi_a4" class="answer-label">Answer for Q4</label><textarea id="lrdi_a4" name="lrdi_a4"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q5">Question 5</label><textarea id="lrdi_q5" name="lrdi_q5"></textarea><label for="lrdi_a5" class="answer-label">Answer for Q5</label><textarea id="lrdi_a5" name="lrdi_a5"></textarea></div>
                </div>
            </div>

            <div class="passage-block">
                <h3>LRDI Set 2 (Questions 6-10)</h3>
                <textarea id="lrdi_para2" name="lrdi_para2" class="passage-input" placeholder="Paste the text for LRDI Set 2 here..."></textarea>
                 <div class="image-upload-area" id="image-area-2">
                    <label>Image for Set 2 (Optional)</label>
                    <div class="image-drop-zone">
                        <p>Drag & Drop, Paste, or Click to Select</p>
                    </div>
                    <button type="button" class="paste-btn">Paste from Clipboard</button>
                    <input type="file" class="file-input" accept="image/png, image/jpeg">
                    <img class="image-preview" alt="Image preview for Set 2">
                </div>
                <div class="questions-grid">
                     <div class="qa-pair"><label for="lrdi_q6">Question 6</label><textarea id="lrdi_q6" name="lrdi_q6"></textarea><label for="lrdi_a6" class="answer-label">Answer for Q6</label><textarea id="lrdi_a6" name="lrdi_a6"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q7">Question 7</label><textarea id="lrdi_q7" name="lrdi_q7"></textarea><label for="lrdi_a7" class="answer-label">Answer for Q7</label><textarea id="lrdi_a7" name="lrdi_a7"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q8">Question 8</label><textarea id="lrdi_q8" name="lrdi_q8"></textarea><label for="lrdi_a8" class="answer-label">Answer for Q8</label><textarea id="lrdi_a8" name="lrdi_a8"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q9">Question 9</label><textarea id="lrdi_q9" name="lrdi_q9"></textarea><label for="lrdi_a9" class="answer-label">Answer for Q9</label><textarea id="lrdi_a9" name="lrdi_a9"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q10">Question 10</label><textarea id="lrdi_q10" name="lrdi_q10"></textarea><label for="lrdi_a10" class="answer-label">Answer for Q10</label><textarea id="lrdi_a10" name="lrdi_a10"></textarea></div>
                </div>
            </div>

            <div class="passage-block">
                <h3>LRDI Set 3 (Questions 11-15)</h3>
                <textarea id="lrdi_para3" name="lrdi_para3" class="passage-input" placeholder="Paste the text for LRDI Set 3 here..."></textarea>
                 <div class="image-upload-area" id="image-area-3">
                    <label>Image for Set 3 (Optional)</label>
                    <div class="image-drop-zone">
                        <p>Drag & Drop, Paste, or Click to Select</p>
                    </div>
                    <button type="button" class="paste-btn">Paste from Clipboard</button>
                    <input type="file" class="file-input" accept="image/png, image/jpeg">
                    <img class="image-preview" alt="Image preview for Set 3">
                </div>
                <div class="questions-grid">
                    <div class="qa-pair"><label for="lrdi_q11">Question 11</label><textarea id="lrdi_q11" name="lrdi_q11"></textarea><label for="lrdi_a11" class="answer-label">Answer for Q11</label><textarea id="lrdi_a11" name="lrdi_a11"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q12">Question 12</label><textarea id="lrdi_q12" name="lrdi_q12"></textarea><label for="lrdi_a12" class="answer-label">Answer for Q12</label><textarea id="lrdi_a12" name="lrdi_a12"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q13">Question 13</label><textarea id="lrdi_q13" name="lrdi_q13"></textarea><label for="lrdi_a13" class="answer-label">Answer for Q13</label><textarea id="lrdi_a13" name="lrdi_a13"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q14">Question 14</label><textarea id="lrdi_q14" name="lrdi_q14"></textarea><label for="lrdi_a14" class="answer-label">Answer for Q14</label><textarea id="lrdi_a14" name="lrdi_a14"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q15">Question 15</label><textarea id="lrdi_q15" name="lrdi_q15"></textarea><label for="lrdi_a15" class="answer-label">Answer for Q15</label><textarea id="lrdi_a15" name="lrdi_a15"></textarea></div>
                </div>
            </div>

            <div class="passage-block">
                <h3>LRDI Set 4 (Questions 16-20)</h3>
                <textarea id="lrdi_para4" name="lrdi_para4" class="passage-input" placeholder="Paste the text for LRDI Set 4 here..."></textarea>
                 <div class="image-upload-area" id="image-area-4">
                    <label>Image for Set 4 (Optional)</label>
                    <div class="image-drop-zone">
                        <p>Drag & Drop, Paste, or Click to Select</p>
                    </div>
                    <button type="button" class="paste-btn">Paste from Clipboard</button>
                    <input type="file" class="file-input" accept="image/png, image/jpeg">
                    <img class="image-preview" alt="Image preview for Set 4">
                </div>
                <div class="questions-grid">
                    <div class="qa-pair"><label for="lrdi_q16">Question 16</label><textarea id="lrdi_q16" name="lrdi_q16"></textarea><label for="lrdi_a16" class="answer-label">Answer for Q16</label><textarea id="lrdi_a16" name="lrdi_a16"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q17">Question 17</label><textarea id="lrdi_q17" name="lrdi_q17"></textarea><label for="lrdi_a17" class="answer-label">Answer for Q17</label><textarea id="lrdi_a17" name="lrdi_a17"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q18">Question 18</label><textarea id="lrdi_q18" name="lrdi_q18"></textarea><label for="lrdi_a18" class="answer-label">Answer for Q18</label><textarea id="lrdi_a18" name="lrdi_a18"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q19">Question 19</label><textarea id="lrdi_q19" name="lrdi_q19"></textarea><label for="lrdi_a19" class="answer-label">Answer for Q19</label><textarea id="lrdi_a19" name="lrdi_a19"></textarea></div>
                    <div class="qa-pair"><label for="lrdi_q20">Question 20</label><textarea id="lrdi_q20" name="lrdi_q20"></textarea><label for="lrdi_a20" class="answer-label">Answer for Q20</label><textarea id="lrdi_a20" name="lrdi_a20"></textarea></div>
                </div>
            </div>

            <button type="submit" class="submit-btn">Begin Analysis & Generate PDF</button>
            <p id="status-message"></p>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- 1. Motivating Typewriter Greeting ---
        const greetingElement = document.getElementById('greeting');
        const greetingText = "Hello rv, let's conquer this.";
        let i = 0;
        function typeWriter() {
            if (i < greetingText.length) {
                greetingElement.innerHTML = greetingText.substring(0, i + 1);
                i++;
                setTimeout(typeWriter, 90);
            } else {
                greetingElement.style.borderRight = 'none';
            }
        }
        window.addEventListener('load', typeWriter);

        // --- 2. Supabase Integration & Form Logic ---
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const form = document.getElementById('main-form');
        const statusMessage = document.getElementById('status-message');
        
        // --- 3. REWRITTEN & FIXED Image Handling Logic ---
        let imageFilesToUpload = {}; // Store files to be uploaded, keyed by area ID

        document.querySelectorAll('.image-upload-area').forEach(area => {
            const dropZone = area.querySelector('.image-drop-zone');
            const fileInput = area.querySelector('.file-input');
            const pasteBtn = area.querySelector('.paste-btn');
            const previewImg = area.querySelector('.image-preview');

            // Store the file object when handled
            const handleFile = (file) => {
                if (!file || !file.type.startsWith('image/')) {
                    alert("Please select a valid image file.");
                    return;
                }
                imageFilesToUpload[area.id] = file;

                // Show preview
                const reader = new FileReader();
                reader.onload = () => {
                    previewImg.src = reader.result;
                    previewImg.style.display = 'block';
                };
                reader.readAsDataURL(file);
            };

            // Event listener for the drop zone (click to select file)
            dropZone.addEventListener('click', () => fileInput.click());

            // Event listener for the actual file input
            fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

            // Event listeners for drag and drop
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });

            // Event listener for the "Paste from Clipboard" button
            pasteBtn.addEventListener('click', async () => {
                try {
                    // Check for permission first
                    const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                    if (permission.state === 'denied') {
                        throw new Error('Clipboard permission denied. Please enable it in your browser settings.');
                    }
                    
                    const clipboardItems = await navigator.clipboard.read();
                    let foundImage = false;
                    for (const item of clipboardItems) {
                        const imageType = item.types.find(type => type.startsWith('image/'));
                        if (imageType) {
                            const blob = await item.getType(imageType);
                            // Give it a default name for Supabase upload
                            const fileName = `pasted-image-${Date.now()}.png`;
                            const file = new File([blob], fileName, { type: blob.type });
                            handleFile(file);
                            foundImage = true;
                            break;
                        }
                    }
                    if (!foundImage) alert('No image found on the clipboard.');

                } catch (err) {
                    console.error('Clipboard API error:', err);
                    statusMessage.textContent = err.message || 'Could not access clipboard.';
                    statusMessage.style.color = '#ff6b6b';
                }
            });
        });


        // --- 4. Main Form Submission Handler ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                statusMessage.textContent = 'ERROR: Please configure your Supabase credentials.';
                statusMessage.style.color = '#ff6b6b';
                return;
            }

            statusMessage.textContent = 'Uploading images...';
            statusMessage.style.color = 'var(--secondary-accent)';

            const uploadedImageUrls = {};
            for (const areaId in imageFilesToUpload) {
                const file = imageFilesToUpload[areaId];
                const fileName = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                
                const { error } = await supabase.storage.from('lrdi_images').upload(fileName, file);
                if (error) {
                    statusMessage.textContent = `Image upload failed: ${error.message}`;
                    statusMessage.style.color = '#ff6b6b'; return;
                }
                
                const { data } = supabase.storage.from('lrdi_images').getPublicUrl(fileName);
                uploadedImageUrls[areaId] = data.publicUrl;
            }

            statusMessage.textContent = 'Submitting data to the analysis queue...';
            const formData = new FormData(form);
            const taskData = {
                input_content: `
[VARC_START]
[PASSAGE_1]${formData.get('passage1')}[/PASSAGE_1][Q1]${formData.get('q1')}[/Q1][A1]${formData.get('a1')}[/A1][Q2]${formData.get('q2')}[/Q2][A2]${formData.get('a2')}[/A2][Q3]${formData.get('q3')}[/Q3][A3]${formData.get('a3')}[/A3][Q4]${formData.get('q4')}[/Q4][A4]${formData.get('a4')}[/A4]
[PASSAGE_2]${formData.get('passage2')}[/PASSAGE_2][Q5]${formData.get('q5')}[/Q5][A5]${formData.get('a5')}[/A5][Q6]${formData.get('q6')}[/Q6][A6]${formData.get('a6')}[/A6][Q7]${formData.get('q7')}[/Q7][A7]${formData.get('a7')}[/A7][Q8]${formData.get('q8')}[/Q8][A8]${formData.get('a8')}[/A8]
[PASSAGE_3]${formData.get('passage3')}[/PASSAGE_3][Q9]${formData.get('q9')}[/Q9][A9]${formData.get('a9')}[/A9][Q10]${formData.get('q10')}[/Q10][A10]${formData.get('a10')}[/A10][Q11]${formData.get('q11')}[/Q11][A11]${formData.get('a11')}[/A11][Q12]${formData.get('q12')}[/Q12][A12]${formData.get('a12')}[/A12]
[PASSAGE_4]${formData.get('passage4')}[/PASSAGE_4][Q13]${formData.get('q13')}[/Q13][A13]${formData.get('a13')}[/A13][Q14]${formData.get('q14')}[/Q14][A14]${formData.get('a14')}[/A14][Q15]${formData.get('q15')}[/Q15][A15]${formData.get('a15')}[/A15][Q16]${formData.get('q16')}[/Q16][A16]${formData.get('a16')}[/A16]
[Q17]${formData.get('q17')}[/Q17][A17]${formData.get('a17')}[/A17][Q18]${formData.get('q18')}[/Q18][A18]${formData.get('a18')}[/A18][Q19]${formData.get('q19')}[/Q19][A19]${formData.get('a19')}[/A19][Q20]${formData.get('q20')}[/Q20][A20]${formData.get('a20')}[/A20][Q21]${formData.get('q21')}[/Q21][A21]${formData.get('a21')}[/A21][Q22]${formData.get('q22')}[/Q22][A22]${formData.get('a22')}[/A22][Q23]${formData.get('q23')}[/Q23][A23]${formData.get('a23')}[/A23][Q24]${formData.get('q24')}[/Q24][A24]${formData.get('a24')}[/A24]
[VARC_END]
[LRDI_START]
[SET_1]${formData.get('lrdi_para1')}[/SET_1][IMAGE_1]${uploadedImageUrls['image-area-1'] || ''}[/IMAGE_1][LRDI_Q1]${formData.get('lrdi_q1')}[/LRDI_Q1][LRDI_A1]${formData.get('lrdi_a1')}[/LRDI_A1][LRDI_Q2]${formData.get('lrdi_q2')}[/LRDI_Q2][LRDI_A2]${formData.get('lrdi_a2')}[/LRDI_A2][LRDI_Q3]${formData.get('lrdi_q3')}[/LRDI_Q3][LRDI_A3]${formData.get('lrdi_a3')}[/LRDI_A3][LRDI_Q4]${formData.get('lrdi_q4')}[/LRDI_Q4][LRDI_A4]${formData.get('lrdi_a4')}[/LRDI_A4][LRDI_Q5]${formData.get('lrdi_q5')}[/LRDI_Q5][LRDI_A5]${formData.get('lrdi_a5')}[/LRDI_A5]
[SET_2]${formData.get('lrdi_para2')}[/SET_2][IMAGE_2]${uploadedImageUrls['image-area-2'] || ''}[/IMAGE_2][LRDI_Q6]${formData.get('lrdi_q6')}[/LRDI_Q6][LRDI_A6]${formData.get('lrdi_a6')}[/LRDI_A6][LRDI_Q7]${formData.get('lrdi_q7')}[/LRDI_Q7][LRDI_A7]${formData.get('lrdi_a7')}[/LRDI_A7][LRDI_Q8]${formData.get('lrdi_q8')}[/LRDI_Q8][LRDI_A8]${formData.get('lrdi_a8')}[/LRDI_A8][LRDI_Q9]${formData.get('lrdi_q9')}[/LRDI_Q9][LRDI_A9]${formData.get('lrdi_a9')}[/LRDI_A9][LRDI_Q10]${formData.get('lrdi_q10')}[/LRDI_Q10][LRDI_A10]${formData.get('lrdi_a10')}[/LRDI_A10]
[SET_3]${formData.get('lrdi_para3')}[/SET_3][IMAGE_3]${uploadedImageUrls['image-area-3'] || ''}[/IMAGE_3][LRDI_Q11]${formData.get('lrdi_q11')}[/LRDI_Q11][LRDI_A11]${formData.get('lrdi_a11')}[/LRDI_A11][LRDI_Q12]${formData.get('lrdi_q12')}[/LRDI_Q12][LRDI_A12]${formData.get('lrdi_a12')}[/LRDI_A12][LRDI_Q13]${formData.get('lrdi_q13')}[/LRDI_Q13][LRDI_A13]${formData.get('lrdi_a13')}[/LRDI_A13][LRDI_Q14]${formData.get('lrdi_q14')}[/LRDI_Q14][LRDI_A14]${formData.get('lrdi_a14')}[/LRDI_A14][LRDI_Q15]${formData.get('lrdi_q15')}[/LRDI_Q15][LRDI_A15]${formData.get('lrdi_a15')}[/LRDI_A15]
[SET_4]${formData.get('lrdi_para4')}[/SET_4][IMAGE_4]${uploadedImageUrls['image-area-4'] || ''}[/IMAGE_4][LRDI_Q16]${formData.get('lrdi_q16')}[/LRDI_Q16][LRDI_A16]${formData.get('lrdi_a16')}[/LRDI_A16][LRDI_Q17]${formData.get('lrdi_q17')}[/LRDI_Q17][LRDI_A17]${formData.get('lrdi_a17')}[/LRDI_A17][LRDI_Q18]${formData.get('lrdi_q18')}[/LRDI_Q18][LRDI_A18]${formData.get('lrdi_a18')}[/LRDI_A18][LRDI_Q19]${formData.get('lrdi_q19')}[/LRDI_Q19][LRDI_A19]${formData.get('lrdi_a19')}[/LRDI_A19][LRDI_Q20]${formData.get('lrdi_q20')}[/LRDI_Q20][LRDI_A20]${formData.get('lrdi_a20')}[/LRDI_A20]
[LRDI_END]
                `,
                status: 'pending'
            };

            try {
                const { data, error } = await supabase.from('tasks').insert([taskData]);
                if (error) throw error;
                statusMessage.textContent = 'Success! Your analysis request has been queued.';
                statusMessage.style.color = 'var(--secondary-accent)';
                form.reset();
                document.querySelectorAll('.image-preview').forEach(img => {img.src=''; img.style.display='none'});
                imageFilesToUpload = {};
            } catch (error) {
                statusMessage.textContent = `Submission failed: ${error.message}`;
                statusMessage.style.color = '#ff6b6b';
                console.error('Error submitting to Supabase:', error);
            }
        });
    </script>
</body>
</html>
